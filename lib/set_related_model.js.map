{"version":3,"sources":["../src/set_related_model.js"],"names":["setRelatedModel","options","id","modelJson","relatedModel","model","relation","requestId","topLevelJson","existingRelatedModel","topLevelModelJson","topLevelJsonKey","isHasMany","propertyName","find","m","isHasOne","undefined","get","set","push","reverseRelation","setReverseRelation","setMethodName"],"mappings":"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","file":"set_related_model.js","sourcesContent":["import isNumber from 'lodash/isNumber';\r\nimport isPlainObject from 'lodash/isPlainObject';\r\nimport find from 'lodash/find';\r\nimport includes from 'lodash/includes';\r\n\r\nimport BaseModel from './base_model';\r\n\r\nexport default function setRelatedModel(options = {}) {\r\n\r\n  let {\r\n    id,\r\n    modelJson,\r\n    relatedModel, // related model instance, basically the same as existingRelatedModel\r\n    model,\r\n    relation,\r\n    requestId,\r\n    topLevelJson,\r\n  } = options;\r\n\r\n  let existingRelatedModel;\r\n  // id, json, relatedModel,   \r\n\r\n  if (!id && !modelJson && !relatedModel) return;\r\n\r\n  // if only id was passed, try to get json from top level\r\n  if (id && !modelJson) {\r\n    let topLevelModelJson = topLevelJson[relation.topLevelJsonKey];                  \r\n    if (topLevelModelJson) {\r\n      modelJson = find(topLevelModelJson, { id });\r\n    }\r\n  }\r\n\r\n  if (!id && modelJson) id = modelJson.id;\r\n  if (!id && relatedModel) id = relatedModel.id;\r\n\r\n\r\n\r\n  // try to find it in array by id if hasMany relation\r\n  if (relation.isHasMany) {\r\n    existingRelatedModel = model[relation.propertyName].find(m => m.id === id);\r\n  // or just check if property is assigned\r\n  } else if (relation.isHasOne) {\r\n    existingRelatedModel = model[relation.propertyName];\r\n    if (existingRelatedModel && existingRelatedModel.id !== id) existingRelatedModel = undefined;\r\n  }\r\n\r\n\r\n\r\n\r\n  // if no existing related model was not found \r\n  if (!existingRelatedModel) {\r\n\r\n    // if no related model was passed\r\n    if (!relatedModel) {    \r\n\r\n      // if no json passed, then just try to fetch model \r\n      // with given id from the store, if any\r\n      if (!modelJson) {\r\n\r\n        /*\r\n         * !!!!!!!!!!!!!!!!!!!!!!!!!!!\r\n         * TODO\r\n         */\r\n\r\n        relatedModel = relation.relatedModel.get(id)\r\n\r\n      // if not only id was passed in json then do regular\r\n      // processing\r\n      } else {\r\n\r\n        // add relation to its store\r\n        relatedModel = relation.relatedModel.set({\r\n          modelJson,\r\n          requestId,\r\n          topLevelJson\r\n        })\r\n\r\n      }\r\n    }\r\n\r\n    // if we finally got related model, or it was passed\r\n    // add it to relation property\r\n    if (relatedModel) {\r\n\r\n      // push new model to array\r\n      if (relation.isHasMany && !includes(model[relation.propertyName], relatedModel)) {\r\n        model[relation.propertyName].push(relatedModel);\r\n\r\n      // or just assign it to the property\r\n      } else if (relation.isHasOne) {\r\n        model[relation.propertyName] = relatedModel;\r\n      }\r\n\r\n      // if there is reverse relation, add current model\r\n      // to the related model's reverse relation.\r\n      let reverseRelation = relation.reverseRelation;\r\n      if (reverseRelation) {\r\n        let setReverseRelation = relatedModel[reverseRelation.setMethodName]\r\n        // console.log('reverseRelation', relation, relatedModel, reverseRelation.setMethodName, model)\r\n        if (setReverseRelation) setReverseRelation({ relatedModel: model });\r\n      }\r\n\r\n    }\r\n\r\n    return relatedModel;\r\n\r\n  // if there is existing related model\r\n  } else {\r\n\r\n    // update it with json if it was passed\r\n    if (modelJson) {\r\n      existingRelatedModel.set({\r\n        requestId,\r\n        modelJson,\r\n        topLevelJson\r\n      });\r\n    }\r\n\r\n    return existingRelatedModel;\r\n\r\n  }\r\n\r\n}"]}