{"version":3,"sources":["../src/set_relations_defaults.js"],"names":["setRelationsDefaults","model","constructor","getModel","Error","relations","forEach","relation","_isPrepared","Object","defineProperty","get","type","isHasMany","initialValue","isHasOne","relatedModel","propertyName","modelName","name","jsonKey","topLevelJsonKey","foreignKey","setMethodName","removeMethodName","reverseRelation","onDestroy"],"mappings":"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","file":"set_relations_defaults.js","sourcesContent":["import { upperCaseFirstLetter, lowercaseFirstLetter } from './utils';\r\nimport {\r\n  pluralize, underscore, tableize, foreign_key,\r\n  singularize\r\n} from 'inflection';\r\nimport isBoolean from 'lodash/isBoolean';\r\nimport isString from 'lodash/isString';\r\n\r\n// mutate static relations and add defaults\r\n// to each relation\r\nexport default function setRelationsDefaults(model) {\r\n\r\n  if (!model.constructor.getModel) {\r\n    throw new Error(\"getModel static method must be defined for a \\\r\n                     base model class, that returns model class given its name\")\r\n  }\r\n\r\n  model.constructor.relations.forEach(relation => {\r\n\r\n    if (relation._isPrepared) return;\r\n\r\n    // console.log('setRelationsDefaults', model, relation)   \r\n\r\n    // shorthand method to quickly check if relation is of hasMany type\r\n    Object.defineProperty(relation, \"isHasMany\", {\r\n      get: function() {\r\n        return this.type === 'hasMany'\r\n      }\r\n    });\r\n\r\n    // shorthand method to quickly check if relation is of hasOne type\r\n    Object.defineProperty(relation, \"isHasOne\", {\r\n      get: function() {\r\n        return this.type === 'hasOne'\r\n      }\r\n    });\r\n\r\n    // set initialValue for relation property\r\n    if (relation.isHasMany) {\r\n      relation.initialValue = [];\r\n    } else if (relation.isHasOne) {\r\n      relation.initialValue = null;\r\n    }\r\n\r\n    if (isString(relation.relatedModel)) {\r\n      relation.relatedModel = model.constructor.getModel(relation.relatedModel);\r\n    }\r\n\r\n    // property name on model instance to relation(s)\r\n    if (!relation.propertyName) {\r\n      relation.propertyName = lowercaseFirstLetter(relation.relatedModel.modelName || relation.relatedModel.name);\r\n\r\n      if (relation.isHasMany) {\r\n        relation.propertyName = pluralize(relation.propertyName)\r\n      }\r\n    }\r\n\r\n    // json key for embedded json\r\n    if (!relation.jsonKey) {\r\n      relation.jsonKey = underscore(relation.propertyName);\r\n    }\r\n\r\n    // key in top level json\r\n    if (!relation.topLevelJsonKey) {\r\n      relation.topLevelJsonKey = tableize(relation.propertyName);\r\n    }\r\n\r\n    // foreign key with ids of relations\r\n    if (!relation.foreignKey) {\r\n      if (relation.isHasMany) {\r\n        relation.foreignKey = foreign_key(singularize(relation.propertyName)) + 's';\r\n      } else if (relation.isHasOne) {\r\n        relation.foreignKey = foreign_key(relation.propertyName);\r\n      }\r\n    }\r\n\r\n    let name = upperCaseFirstLetter(relation.propertyName);\r\n    if (relation.isHasMany) name = singularize(name);\r\n\r\n    // method name to add single relation, will be used as alias\r\n    if (!relation.setMethodName) {      \r\n      relation.setMethodName = `set${name}`;\r\n    }\r\n\r\n    // method name to remove single relation, will be used as alias\r\n    if (!relation.removeMethodName) {\r\n      relation.removeMethodName = `remove${name}`;\r\n    }\r\n\r\n    let reverseRelation = relation.reverseRelation;\r\n\r\n    if (reverseRelation) {      \r\n\r\n      if (isBoolean(reverseRelation)) {\r\n        reverseRelation = relation.reverseRelation = {};\r\n      }\r\n\r\n      if (!reverseRelation.onDestroy && reverseRelation.onDestroy !== false) {\r\n        reverseRelation.onDestroy = 'removeSelf'\r\n      }\r\n\r\n      if (!reverseRelation.propertyName) {\r\n        reverseRelation.propertyName = lowercaseFirstLetter(model.constructor.modelName || model.constructor.name);\r\n      }\r\n\r\n      let name = upperCaseFirstLetter(reverseRelation.propertyName);\r\n\r\n      if (!reverseRelation.setMethodName) {        \r\n        reverseRelation.setMethodName = `set${name}`;\r\n      }\r\n\r\n      if (!reverseRelation.removeMethodName) {        \r\n        reverseRelation.removeMethodName = `remove${name}`;\r\n      }\r\n\r\n      //console.log('setRelationsDefaults reverseRelation is true', relation.reverseRelation, relation)\r\n\r\n    }\r\n\r\n    relation._isPrepared = true;\r\n\r\n  });\r\n\r\n}"]}