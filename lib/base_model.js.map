{"version":3,"sources":["../src/base_model.js"],"names":["initObservables","target","observables","collection","shallow","BaseModel","actionName","method","Object","defineProperty","get","bind","configurable","prototype","options","modelJson","topLevelJson","requestId","constructor","id","model","onInitialize","lastSetRequestId","removeSelfFromCollection","destroyDependentRelations","removeSelfFromRelations","remove","relationsToDestroy","relations","reverseRelation","relation","onDestroy","forEach","isHasMany","propertyName","slice","relatedModel","isHasOne","relationsToRemoveFrom","removeMethodName","attributes","attributeValues","keys","reduce","values","attributeName","relationValues","type","foreignKey","camelizedForeignKey","map","urlRoot","jsonKey","items","l","length","i","toString","set","push","splice","indexOf","all","_urlRoot","modelName","name","value","_jsonKey"],"mappings":"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","file":"base_model.js","sourcesContent":["import {\n    transaction,\n    extendObservable,\n    isObservableArray,\n    observable\n} from \"mobx\";\nimport { tableize, underscore, camelize } from \"inflection\";\nimport filter from \"lodash/filter\";\nimport uniqueId from \"lodash/uniqueId\";\nimport result from \"lodash/result\";\n\nimport initAttributes from \"./init_attributes\";\nimport setAttributes from \"./set_attributes\";\nimport initRelations from \"./init_relations\";\nimport setRelations from \"./set_relations\";\n\n/*\n * This is a hack to allow each model that extends\n * BaseModel to have its own observable collection. Model is\n * assigned an observable collection when first instance of model is\n * created or when Model.all() method is called\n */\nconst initObservables = function(target) {\n    if (\n        !target.observables ||\n        !isObservableArray(target.observables.collection)\n    ) {\n        target.observables = {};\n        extendObservable(target.observables, {\n            collection: observable.shallow([])\n        });\n    }\n};\n\nclass BaseModel {\n    static attributes = {};\n    static relations = [];\n    // static observables = {};\n\n    id = null;\n    lastSetRequestId = null;\n\n    // static config = function(options = {}) {\n    //   let { models } = options;\n    //   this.models = models;\n    // };\n\n    /*\n   * NOTE: we access internal mobservable array of values to\n   * prevent notifying observers when we're just getting single\n   * value. This way we'll prevent re-rendering components displaying\n   * single model when collection changes\n   */\n    static get = function(id) {\n        let items = result(this, \"observables.$mobx.values.collection.value\");\n        if (items && isObservableArray(items)) {\n            let l = items.length;\n            for (var i = 0; i < l; i++) {\n                if (items[i].id.toString() === id.toString()) return items[i];\n            }\n        }\n\n        return null;\n    };\n\n    static set = function(options = {}) {\n        // console.log('set static', this.name)\n\n        let { modelJson, topLevelJson, requestId } = options;\n\n        /*\n      requestId is used to allow models to \n      prevent loops when setting same attributes\n      multiple times, we set one if none is set\n     */\n        if (!requestId) requestId = uniqueId(\"request_\");\n\n        /*\n     * topLevelJson is used to get json for models referenced by ids\n     */\n        if (!topLevelJson) topLevelJson = modelJson;\n\n        let model = this.get(modelJson.id);\n\n        transaction(() => {\n            if (!model) {\n                model = new this({\n                    modelJson,\n                    topLevelJson,\n                    requestId\n                });\n\n                this.observables.collection.push(model);\n            }\n\n            model.set({ modelJson, topLevelJson, requestId });\n        });\n\n        // console.log('set', model)\n\n        return model;\n    };\n\n    static remove = function(model) {\n        if (\n            this.observables &&\n            isObservableArray(this.observables.collection)\n        ) {\n            this.observables.collection.splice(\n                this.observables.collection.indexOf(model),\n                1\n            );\n        }\n    };\n\n    static all = function() {\n        initObservables(this);\n        return this.observables.collection.slice();\n    };\n\n    static addClassAction(actionName, method) {\n        Object.defineProperty(this, actionName, {\n            get: function() {\n                return method.bind(this);\n            },\n            configurable: true\n        });\n    }\n\n    static addAction(actionName, method) {\n        Object.defineProperty(this.prototype, actionName, {\n            get: function() {\n                return method.bind(this);\n            },\n            configurable: true\n        });\n    }\n\n    constructor(options = {}) {\n        let { modelJson, topLevelJson, requestId } = options;\n\n        initObservables(this.constructor);\n\n        if (modelJson && modelJson.id) {\n            this.id = modelJson.id;\n        }\n\n        initAttributes({ model: this });\n        initRelations({ model: this });\n\n        this.onInitialize();\n    }\n\n    set(options = {}) {\n        let { requestId, modelJson, topLevelJson } = options;\n        let model = this;\n\n        if (!requestId) requestId = uniqueId(\"request_\");\n\n        if (this.lastSetRequestId === requestId) {\n            return;\n        } else {\n            this.lastSetRequestId = requestId;\n        }\n\n        transaction(() => {\n            setAttributes({ model, modelJson });\n\n            setRelations({\n                model,\n                requestId,\n                modelJson,\n                topLevelJson\n            });\n        });\n    }\n\n    get urlRoot() {\n        return this.constructor.urlRoot;\n    }\n\n    get jsonKey() {\n        return this.constructor.jsonKey;\n    }\n\n    onInitialize() {}\n\n    onDestroy() {\n        transaction(() => {\n            this.removeSelfFromCollection();\n            this.destroyDependentRelations();\n            this.removeSelfFromRelations();\n        });\n    }\n\n    removeSelfFromCollection() {\n        this.constructor.remove(this);\n    }\n\n    destroyDependentRelations() {\n        let relationsToDestroy = filter(\n            this.constructor.relations,\n            relation => {\n                let reverseRelation = relation.reverseRelation;\n                return (\n                    reverseRelation &&\n                    reverseRelation.onDestroy === \"destroyRelation\"\n                );\n            }\n        );\n\n        relationsToDestroy.forEach(relation => {\n            if (relation.isHasMany) {\n                this[relation.propertyName].slice().forEach(relatedModel => {\n                    relatedModel.onDestroy();\n                });\n            } else if (relation.isHasOne) {\n                this[relation.propertyName].onDestroy();\n            }\n        });\n    }\n\n    removeSelfFromRelations() {\n        let relationsToRemoveFrom = filter(\n            this.constructor.relations,\n            relation => {\n                let reverseRelation = relation.reverseRelation;\n                return (\n                    reverseRelation &&\n                    reverseRelation.onDestroy === \"removeSelf\"\n                );\n            }\n        );\n\n        relationsToRemoveFrom.forEach(relation => {\n            let removeMethodName = relation.reverseRelation.removeMethodName;\n\n            if (relation.isHasMany) {\n                this[relation.propertyName].slice().forEach(relatedModel => {\n                    if (relatedModel[removeMethodName]) {\n                        relatedModel[removeMethodName](this);\n                    }\n                });\n            } else if (relation.isHasOne) {\n                // console.log(relation.propertyName, removeMethodName, this[relation.propertyName])\n                if (\n                    this[relation.propertyName] &&\n                    this[relation.propertyName][removeMethodName]\n                ) {\n                    this[relation.propertyName][removeMethodName](this);\n                }\n            }\n        });\n    }\n\n    toJSON() {\n        const { id, constructor } = this;\n        const { attributes, relations } = constructor;\n\n        // collect attributes\n        const attributeValues = Object.keys(attributes || {}).reduce(\n            (values, attributeName) => {\n                values[attributeName] = this[attributeName];\n                return values;\n            },\n            {}\n        );\n\n        // collect relation models id\n        const relationValues = (relations || []).reduce(\n            (values, { type, propertyName, foreignKey }) => {\n                const camelizedForeignKey = camelize(foreignKey, true);\n\n                if (type === \"hasMany\") {\n                    values[camelizedForeignKey] = (this[propertyName] || [])\n                        .slice()\n                        .map(model => model.id);\n                }\n\n                if (type === \"hasOne\") {\n                    values[camelizedForeignKey] = (this[propertyName] || {}).id;\n                }\n\n                return values;\n            },\n            {}\n        );\n\n        return {\n            id,\n            ...attributeValues,\n            ...relationValues\n        };\n    }\n}\n\nObject.defineProperty(BaseModel, \"urlRoot\", {\n    get: function() {\n        return this._urlRoot\n            ? this._urlRoot\n            : \"/\" + tableize(this.modelName || this.name);\n    },\n    set: function(value) {\n        this._urlRoot = value;\n    },\n    configurable: true\n});\n\nObject.defineProperty(BaseModel, \"jsonKey\", {\n    get: function() {\n        return this._jsonKey\n            ? this._jsonKey\n            : underscore(this.modelName || this.name);\n    },\n    set: function(value) {\n        this._jsonKey = value;\n    },\n    configurable: true\n});\n\nexport default BaseModel;\n"]}